name: Auto-update Fish Release

on:
  schedule:
    # Check for new releases weekly (Monday 2 AM UTC)
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest fish release
        id: get_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest release from fish-shell/fish-shell
          RELEASE_INFO=$(gh api repos/fish-shell/fish-shell/releases/latest)
          LATEST_VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name')

          # Remove 'v' prefix if present
          LATEST_VERSION="${LATEST_VERSION#v}"

          echo "version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
          echo "Latest fish version: ${LATEST_VERSION}"

      - name: Check if update is needed
        id: check_update
        run: |
          CURRENT_VERSION=$(grep "^PKG_VERSION:=" packages/fish/Makefile | cut -d= -f2)
          LATEST_VERSION="${{ steps.get_release.outputs.version }}"

          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "latest_version=${LATEST_VERSION}" >> $GITHUB_OUTPUT

          if [ "${CURRENT_VERSION}" != "${LATEST_VERSION}" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed: ${CURRENT_VERSION} -> ${LATEST_VERSION}"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "Already on latest version: ${CURRENT_VERSION}"
          fi

      - name: Extract hash from GitHub API
        id: calculate_hash
        if: steps.check_update.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST_VERSION="${{ steps.get_release.outputs.version }}"
          TARBALL="fish-${LATEST_VERSION}.tar.xz"

          echo "Fetching release info from GitHub API"

          # Get the release data from the API
          RELEASE_DATA=$(gh api repos/fish-shell/fish-shell/releases/tags/${LATEST_VERSION})

          # Extract the SHA256 digest for fish-X.X.X.tar.xz from assets
          HASH=$(echo "$RELEASE_DATA" | jq -r ".assets[] | select(.name == \"${TARBALL}\") | .digest" | sed 's/sha256://')

          if [ -z "$HASH" ]; then
            echo "Error: Could not extract hash from GitHub API response"
            exit 1
          fi

          echo "hash=${HASH}" >> $GITHUB_OUTPUT
          echo "tarball=${TARBALL}" >> $GITHUB_OUTPUT
          echo "Extracted hash: ${HASH}"

      - name: Update Makefile
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          LATEST_VERSION="${{ steps.get_release.outputs.version }}"
          HASH="${{ steps.calculate_hash.outputs.hash }}"

          # Update PKG_VERSION and PKG_HASH in the Makefile
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=${LATEST_VERSION}/" packages/fish/Makefile
          sed -i "s/^PKG_HASH:=.*/PKG_HASH:=${HASH}/" packages/fish/Makefile

          echo "Updated packages/fish/Makefile:"
          grep -E "^PKG_VERSION:|^PKG_HASH:" packages/fish/Makefile

      - name: Create Pull Request
        if: steps.check_update.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ github.token }}
          commit-message: "Update fish to v${{ steps.get_release.outputs.version }}"
          title: "Update fish to v${{ steps.get_release.outputs.version }}"
          body: |
            Automatically updated fish shell to the latest release.

            **Changes:**
            - Updated `PKG_VERSION` from `${{ steps.check_update.outputs.current_version }}` to `${{ steps.get_release.outputs.version }}`
            - Updated `PKG_HASH` to `${{ steps.calculate_hash.outputs.hash }}`

            This PR was automatically generated by the update-fish-release workflow.
          branch: update-fish-${{ steps.get_release.outputs.version }}
          delete-branch: true
          labels: |
            automated
            dependency-update
